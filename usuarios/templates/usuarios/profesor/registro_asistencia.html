{% extends "usuarios/profesor/base_profesor.html" %}

{% block content %}

<h4 class="mb-4">üìã Registro de Asistencia por Grupo</h4>

<div class="row mb-3 align-items-end">
    <div class="col-md-6">
        <label for="grupo_select" class="form-label fw-bold">Seleccionar Grupo:</label>
        <select class="form-select" id="grupo_select">
            <option value="">-- Elija un Grupo --</option>
            {% for grupo in grupos_asignados %}
                <option value="{{ grupo.id }}" {% if grupo_seleccionado and grupo_seleccionado.id == grupo.id %}selected{% endif %}>
                    {{ grupo.curso.id }} - {{ grupo.curso.nombre }} ({{ grupo.grupo }}) ‚Äî ({{ grupo.tipo }})
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label for="fecha_select" class="form-label fw-bold">Fecha (ver detalle):</label>
        <input type="date" id="fecha_select" class="form-control"
               value="{{ fecha_url|default:fecha_actual_str }}">
    </div>

    <div class="col-md-3 d-flex align-items-end gap-2">
        <button id="btn_ver" class="btn btn-primary w-100">Ver Detalle</button>
    </div>
</div>

<!-- √Årea para mensajes de error de selecci√≥n (mejor que alert()) -->
<div id="error-message" class="alert alert-danger p-2 small mt-2" style="display:none;"></div>

<script>
document.getElementById('btn_ver').addEventListener('click', function() {
    const g = document.getElementById('grupo_select').value;
    const f = document.getElementById('fecha_select').value;
    const errorBox = document.getElementById('error-message');
    errorBox.style.display = 'none'; // Ocultar mensaje anterior

    if (!g) {
        errorBox.textContent = 'Seleccione un grupo para continuar.';
        errorBox.style.display = 'block';
        return;
    }
    
    // Si la fecha est√° vac√≠a, la omitimos en la URL y el backend usar√° la fecha actual por defecto.
    if (!f) {
        window.location.href = '{% url "usuarios:registro_asistencia" %}?grupo=' + g;
    } else {
        window.location.href = '{% url "usuarios:registro_asistencia" %}?grupo=' + g + '&fecha=' + f;
    }
});
</script>

<!-- Historial compacto y export -->

<div class="card shadow-sm mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <strong>Historial:</strong>
            {% if historial_completo %}
                <span class="text-muted small ms-2">√öltimas {{ historial_completo|length }} sesiones</span>
            {% else %}
                <span class="text-muted small ms-2">Sin registros a√∫n</span>
            {% endif %}
        </div>

    <div class="d-flex gap-2">
        {% if grupo_seleccionado %}
            <form method="POST" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="accion" value="export_excel">
                <input type="hidden" name="grupo_export" value="{{ grupo_seleccionado.id }}">
                <button class="btn btn-outline-success btn-sm" type="submit">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i> Exportar Excel
                </button>
            </form>

            <form method="POST" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="accion" value="export_pdf">
                <input type="hidden" name="grupo_export" value="{{ grupo_seleccionado.id }}">
                <button class="btn btn-outline-danger btn-sm" type="submit">
                    <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                </button>
            </form>
        {% endif %}
    </div>
</div>

{% if historial_completo %}
<div class="card-footer p-2">
    <div class="d-flex flex-wrap gap-2">
        {% for item in historial_completo|slice:":8" %}
            <a href="{% url 'usuarios:registro_asistencia' %}?grupo={{ grupo_seleccionado.id }}&fecha={{ item.fechaClase|date:'Y-m-d' }}" class="badge bg-secondary text-white">
                {{ item.fechaClase|date:"d/m/Y" }} ‚Äî P:{{ item.presentes }} / F:{{ item.faltas }}
            </a>
        {% endfor %}
        {% if historial_completo|length > 8 %}
            <span class="text-muted small align-self-center ms-2">... m√°s ({{ historial_completo|length }})</span>
        {% endif %}
    </div>
</div>
{% endif %}

</div>

<!-- Detalle por fecha -->

{% if grupo_seleccionado and fecha_url %}

<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title">
            {{ grupo_seleccionado.curso.nombre }} (Grupo {{ grupo_seleccionado.grupo }})
            <small class="text-muted"> ‚Äî Fecha: {{ fecha_url }}</small>
            {% if editable %}
                <span class="badge bg-success ms-2">Editable (hoy)</span>
            {% else %}
                <span class="badge bg-secondary ms-2">S√≥lo lectura</span>
            {% endif %}
        </h5>

    {% if estudiantes_matriculados %}
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="accion" value="save_all">
            <input type="hidden" name="grupo_id" value="{{ grupo_seleccionado.id }}">
            <input type="hidden" name="fecha_sesion" value="{{ fecha_url }}">

            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:14%;">CUI</th>
                            <th>Alumno</th>
                            <th style="width:18%;">Asisti√≥</th>
                            <th style="width:18%;">Falt√≥</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for est in estudiantes_matriculados %}
                    <tr>
                        <td class="text-muted small">{{ est.cui }}</td>
                        <td>{{ est.nombre }}</td>
                        <td>
                            {% if editable %}
                                <!-- IMPORTANTE: Se agreg√≥ data-cui -->
                                <input type="checkbox" class="chk_asistencia" name="asistencia_{{ est.cui }}" value="A"
                                data-cui="{{ est.cui }}" 
                                {% if est.estado == 'A' %}checked{% endif %}>
                            {% else %}
                                <span class="badge {% if est.estado == 'A' %}bg-success{% else %}bg-light text-muted{% endif %}">
                                    {% if est.estado == 'A' %}‚úì{% endif %}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if editable %}
                                <!-- IMPORTANTE: Se agreg√≥ name="falta_<cui>" y data-cui -->
                                <input type="checkbox" class="chk_falta" name="falta_{{ est.cui }}" value="F"
                                data-cui="{{ est.cui }}" 
                                {% if est.estado == 'F' %}checked{% endif %}>
                            {% else %}
                                <span class="badge {% if est.estado == 'F' %}bg-danger{% else %}bg-light text-muted{% endif %}">
                                    {% if est.estado == 'F' %}‚úó{% endif %}
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if editable %}
                <button type="submit" class="btn btn-primary">Guardar Todos</button>
            {% endif %}
        </form>

        {% if editable %}
        <script>
        // Asegura que solo se seleccione una opci√≥n por estudiante
        document.querySelectorAll('.chk_asistencia').forEach(function(chk) {
            chk.addEventListener('change', function() {
                const cui = this.dataset.cui; // Usar data-cui
                // Buscar el checkbox opuesto por su data-cui
                const falta = document.querySelector('.chk_falta[data-cui="'+cui+'"]'); 
                if (this.checked) { falta.checked = false; }
            });
        });
        document.querySelectorAll('.chk_falta').forEach(function(chk) {
            chk.addEventListener('change', function() {
                const cui = this.dataset.cui; // Usar data-cui
                // Buscar el checkbox opuesto por su data-cui
                const asis = document.querySelector('.chk_asistencia[data-cui="'+cui+'"]');
                if (this.checked) { asis.checked = false; }
            });
        });
        </script>
        {% endif %}
    {% else %}
        <div class="alert alert-warning">No hay estudiantes matriculados para este grupo.</div>
    {% endif %}
</div>

</div>

{% elif grupo_seleccionado and not fecha_url %}

<div class="alert alert-info">
Seleccione una fecha (arriba) para ver el detalle de asistencia de esa sesi√≥n, o use las etiquetas del historial.
</div>
{% else %}
<div class="alert alert-secondary mt-3">
Seleccione un grupo para ver su historial y opciones de exportaci√≥n.
</div>
{% endif %}

{% endblock content %}